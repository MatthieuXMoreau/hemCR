---
title: "Comparison between trajectories in the Gmnc WT/KO"
author:
   - Matthieu Moreau^[Institute of Psychiatry and Neuroscience of Paris, INSERM U1266, 75014, Paris, France, matthieu.moreau@inserm.fr] [![](https://orcid.org/sites/default/files/images/orcid_16x16.png)](https://orcid.org/0000-0002-2592-2373)
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_download: yes
    df_print: tibble
    highlight: haddock
    theme: cosmo
    css: "../style.css"
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message=FALSE, warning=FALSE, cache.lazy = FALSE)

# To use biomart 
new_config <- httr::config(ssl_verifypeer = FALSE)
httr::set_config(new_config, override = FALSE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(princurve)
library(Revelio)
library(monocle)
library(gprofiler2)
library(seriation)
library(Matrix)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(ggExtra)
library(cowplot)
library(wesanderson)

#Set ggplot theme as classic
theme_set(theme_classic())
```

# Pseudotime in the WT

```{r}
WT <- readRDS("../QC.filtered.clustered.cells.RDS")
```

## Extract CR and CP neurons 
```{r}
WT$Lineage <- sapply(WT$Cell_ident,
                              FUN = function(x) {
                                if (x %in% c("Cajal-Retzius_neurons", "Hem")) {
                                  x = "Cajal-Retzius_neurons"
                                } else if (x %in% c("Pallial_neurons", "Medial_pallium")) {
                                  x = "Pallial_neurons"
                                } else if(x %in% c("ChP", "ChP_progenitors")) {
                                   x =  "Choroid_Plexus"
                                } else {
                                  x = "other"
                                  }
                              })
```

```{r}
Neurons.data <-  subset(WT, idents = c("Cajal-Retzius_neurons", "Pallial_neurons"))

DimPlot(Neurons.data,
        reduction = "spring",
        pt.size = 1,
        cols =  c("#cc391b","#026c9a")
        ) + NoAxes()

rm(WT)
```
## Fit principale curve on the two lineages

### Cajal-Retzius cells

```{r}
Trajectories.Hem <- Neurons.data@meta.data %>%
                    select("Barcodes", "nUMI", "Spring_1", "Spring_2", "AP_signature1","BP_signature1", "EN_signature1", "LN_signature1", "Lineage") %>%
                    filter(Lineage == "Cajal-Retzius_neurons")
```

```{r}
fit <- principal_curve(as.matrix(Trajectories.Hem[,c("Spring_1", "Spring_2")]),
                       smoother='lowess',
                       trace=TRUE,
                       f = .7,
                       stretch=0)

#The principal curve smoothed
Hem.pc.line <- as.data.frame(fit$s[order(fit$lambda),]) 

#Pseudotime score
Trajectories.Hem$PseudotimeScore <- fit$lambda/max(fit$lambda)

```

```{r}
if (cor(Trajectories.Hem$PseudotimeScore, Neurons.data@assays$SCT@data['Hmga2', Trajectories.Hem$Barcodes]) > 0) {
  Trajectories.Hem$PseudotimeScore <- -(Trajectories.Hem$PseudotimeScore - max(Trajectories.Hem$PseudotimeScore))
}
```

### Pallial neurons

```{r}
Trajectories.Pallial <- Neurons.data@meta.data %>%
                        select("Barcodes", "nUMI", "Spring_1", "Spring_2", "AP_signature1","BP_signature1", "EN_signature1", "LN_signature1", "Lineage") %>%
                        filter(Lineage == "Pallial_neurons")
                  
```

```{r}
fit <- principal_curve(as.matrix(Trajectories.Pallial[,c("Spring_1", "Spring_2")]),
                       smoother='lowess',
                       trace=TRUE,
                       f = .7,
                       stretch=0)

#The principal curve smoothed
Pallial.pc.line <- as.data.frame(fit$s[order(fit$lambda),])

#Pseudotime score
Trajectories.Pallial$PseudotimeScore <- fit$lambda/max(fit$lambda)
```

```{r}
if (cor(Trajectories.Pallial$PseudotimeScore, Neurons.data@assays$SCT@data['Hmga2', Trajectories.Pallial$Barcodes]) > 0) {
  Trajectories.Pallial$PseudotimeScore <- -(Trajectories.Pallial$PseudotimeScore - max(Trajectories.Pallial$PseudotimeScore))
}
```

### Combine the two trajectories' data

```{r}
Trajectories.neurons <- rbind(Trajectories.Pallial, Trajectories.Hem)
```

```{r}
cols <- brewer.pal(n =11, name = "Spectral")

ggplot(Trajectories.neurons, aes(Spring_1, Spring_2)) +
  geom_point(aes(color=PseudotimeScore), size=2, shape=16) + 
  scale_color_gradientn(colours=rev(cols), name='Speudotime score') +
  geom_line(data=Pallial.pc.line, color="#026c9a", size=0.77) +
  geom_line(data=Hem.pc.line, color="#cc391b", size=0.77)
```

### Plot pan-neuronal genes along this axis

```{r}
Neurons.data <- NormalizeData(Neurons.data, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r fig.dim=c(9,10)}
# Neurog2
p1 <- FeaturePlot(object = Neurons.data,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons$Neurog2 <- Neurons.data@assays$RNA@data["Neurog2", Trajectories.neurons$Barcodes]

p2 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()
Trajectories.neurons$Tbr1 <- Neurons.data@assays$RNA@data["Tbr1", Trajectories.neurons$Barcodes]

p4 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons$Mapt <- Neurons.data@assays$RNA@data["Mapt", Trajectories.neurons$Barcodes]

p6 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```

### Shift Pseudotime in both lineage

Since we observe the first 25% of both trajectories are occupied by few, likely progenitor cells, we shift this cell along the axis

```{r}
Pseudotime.intervals <- Trajectories.neurons%>%
                          select(Lineage, PseudotimeScore) %>%
                          mutate(Pseudotime.bins = cut(Trajectories.neurons$PseudotimeScore, seq(0, max(Trajectories.neurons$PseudotimeScore) + 0.05, 0.05), dig.lab = 2, right = FALSE)) %>%
                          group_by(Lineage, Pseudotime.bins) %>%
                          summarise(n=n())

ggplot(Pseudotime.intervals, aes(x=Pseudotime.bins, y=n, fill=Lineage)) +
        geom_bar(stat = "identity", width = 0.90) +
        theme(axis.text.x = element_text(angle = 45, hjust=1))+
        scale_fill_manual(values= c("#cc391b", "#026c9a"))
```

```{r}
score <- sapply(Trajectories.neurons$PseudotimeScore,
                FUN = function(x) if (x <= 0.2) {x= 0.2} else { x=x })

Trajectories.neurons$PseudotimeScore.shifted <- (score - min(score)) / (max(score) - min(score))
```

```{r fig.dim=c(9,10)}
# Neurog2
p1 <- FeaturePlot(object = Neurons.data ,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p4 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p6 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```

```{r}
ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= nUMI/10000)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)
```

```{r}
rm(list = ls()[!ls() %in% c("Trajectories.neurons")])
```

## Load progenitors with cell cycle trajectory fitted

```{r}
Progenitors.data <- readRDS("../ProgenitorsDiversity/Progenitors.RDS")
```

```{r}
table(Progenitors.data$Cell_ident)
```

To balance the number of progenitors in both domain we will only work with *Hem* and *Medial_pallium* annotated cells. Since we are using pallial cell to contrast CR specific trajectory we think this approximation will not significantly affect our analysis.

```{r}
Progenitors.data <-  subset(Progenitors.data, idents = c("Hem", "Medial_pallium"))
```

```{r fig.dim=c(6, 4)}
p1 <- DimPlot(Progenitors.data,
        reduction = "spring",
        pt.size = 0.5,
        cols =  c("#e3c148", "#e46b6b")) + NoAxes()

p2 <- FeaturePlot(object = Progenitors.data,
            features = "Revelio.cc",
            pt.size = 0.5,
            cols = rev(brewer.pal(10,"Spectral")),
            reduction = "spring",
            order = T) & NoAxes()

p3 <- DimPlot(object = Progenitors.data,
        group.by = "Revelio.phase",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) & NoAxes()

p1 + p2 + p3  + patchwork::plot_layout(ncol = 2)
```

## Combined progenitors and neurons along Pseudotime

```{r}
# Start with neurons data
Trajectories.all <- Trajectories.neurons %>% select(Barcodes, nUMI, Spring_1, Spring_2, AP_signature1, BP_signature1, EN_signature1, LN_signature1, Lineage)

Trajectories.all$Pseudotime <- Trajectories.neurons$PseudotimeScore.shifted + 0.5
Trajectories.all$Phase <- NA
```

```{r}
# Add progenitors data
Trajectories.progenitors <- Progenitors.data@meta.data %>%
                              select(Barcodes, nUMI, Spring_1, Spring_2, AP_signature1, BP_signature1, EN_signature1, LN_signature1) %>% 
                              mutate(Lineage= ifelse(Progenitors.data$Cell_ident == "Medial_pallium", "Pallial_neurons", "Cajal-Retzius_neurons") ,
                                     Pseudotime= Progenitors.data$Revelio.cc/2,
                                     Phase = Progenitors.data$Revelio.phase)
```

```{r}
Trajectories.all <- rbind(Trajectories.all, Trajectories.progenitors)

Trajectories.all$Phase <- factor(Trajectories.all$Phase, levels = c("G1.S", "S", "G2", "G2.M", "M.G1"))
```

```{r fig.dim=c(9,3)}
p1 <- ggplot(Trajectories.all, aes(Spring_1, Spring_2)) +
        geom_point(aes(color=Pseudotime), size=0.5) + 
        scale_color_gradientn(colours=rev(brewer.pal(n =11, name = "Spectral")), name='Pseudotime score')

p2 <- ggplot(Trajectories.all, aes(Spring_1, Spring_2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a"))

p1 + p2
```

```{r fig.dim=c(9,3)}
p1 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= nUMI/10000)) +
        geom_point(aes(color= Phase), size=0.5) +
        scale_color_manual(values= c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) +
        geom_smooth(method="loess", n= 50, fill="grey") +
        ylim(0,NA)

p2 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= nUMI/10000)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, fill="grey") +
        ylim(0,NA)

p1 / p2
```

```{r}
p1 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= AP_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(method="loess", n= 50, fill="grey")


p2 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= BP_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(method="loess", n= 50, fill="grey")

p3 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= EN_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(method="loess", n= 50, fill="grey")

p4 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= LN_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(method="loess", n= 50, fill="grey")


p1 / p2 / p3 / p4
```


```{r}
rm(list = ls()[!ls() %in% c("Trajectories.all")])
```

## Subset the full dataset Seurat object

```{r}
Hem.data <- readRDS("../QC.filtered.clustered.cells.RDS")
```

```{r}
Neuro.trajectories_WT <- CreateSeuratObject(counts = Hem.data@assays$RNA@data[, Trajectories.all$Barcodes],
                                            meta.data = Trajectories.all)

spring <- as.matrix(Neuro.trajectories_WT@meta.data %>% select("Spring_1", "Spring_2"))
  
Neuro.trajectories_WT[["spring"]] <- CreateDimReducObject(embeddings = spring, key = "Spring_", assay = DefaultAssay(Neuro.trajectories_WT))
```

```{r fig.dim=c(6, 12)}
p1 <- FeaturePlot(object = Neuro.trajectories_WT,
            features = "Pseudotime",
            pt.size = 0.5,
            cols = rev(colorRampPalette(brewer.pal(n =11, name = "Spectral"))(100)),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- DimPlot(object = Neuro.trajectories_WT,
        group.by = "Lineage",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c("#cc391b", "#026c9a")) & NoAxes()


p3 <- DimPlot(object = Neuro.trajectories_WT,
        group.by = "Phase",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) & NoAxes()

p1 + p2 + p3
```


```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT")])
```

### Normalization

```{r}
Neuro.trajectories_WT <- NormalizeData(Neuro.trajectories_WT, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r}
Neuro.trajectories_WT <- FindVariableFeatures(Neuro.trajectories_WT, selection.method = "disp", nfeatures = 3000, assay = "RNA")
```

### Plot some genes along pseudotime

```{r fig.dim=c(9,8)}
source("../Functions/functions_GeneTrends.R")

Plot.Genes.trend(Seurat.data= Neuro.trajectories_WT,
                 group.by = "Lineage",
                 genes= c("Gas1","Sox2",
                          "Neurog2", "Btg2",
                          "Tbr1", "Mapt",
                          "Trp73", "Foxg1"))
```

```{r fig.dim=c(9,6)}
Plot.Genes.trend(Seurat.data= Neuro.trajectories_WT,
                 group.by = "Lineage",
                 genes= c("Gmnc", "Mcidas",
                          "Ccno", "Ccdc67",
                          "Foxj1", "Trp73",
                          "Lhx1", "Cdkn1a"))
```

```{r fig.dim=c(9,5)}
Plot.Genes.trend(Seurat.data= Neuro.trajectories_WT,
                 group.by = "Lineage",
                 genes= c("Mki67", "Top2a",
                          "H2afx", "Cdkn1c"))
```

## Use monocle2 to model gene expression along cycling axis

### Initialize a monocle object

```{r}
# Transfer metadata
meta.data <- data.frame(Barcode= Neuro.trajectories_WT$Barcodes,
                        Lineage= Neuro.trajectories_WT$Lineage,
                        Pseudotime= Neuro.trajectories_WT$Pseudotime,
                        Phase= Neuro.trajectories_WT$Phase)

Annot.data  <- new('AnnotatedDataFrame', data = meta.data)

# Transfer counts data
var.genes <- Neuro.trajectories_WT[["RNA"]]@var.features
count.data = data.frame(gene_short_name = rownames(Neuro.trajectories_WT[["RNA"]]@data),
                        row.names = rownames(Neuro.trajectories_WT[["RNA"]]@data))

feature.data <- new('AnnotatedDataFrame', data = count.data)

# Create the CellDataSet object including variable genes only
gbm_cds_WT <- newCellDataSet(Neuro.trajectories_WT[["RNA"]]@counts,
                              phenoData = Annot.data,
                              featureData = feature.data,
                              lowerDetectionLimit = 0,
                              expressionFamily = negbinomial())
```

```{r message=FALSE, warning=FALSE, cache=TRUE}
gbm_cds_WT <- estimateSizeFactors(gbm_cds_WT)
gbm_cds_WT <- estimateDispersions(gbm_cds_WT)
gbm_cds_WT <- detectGenes(gbm_cds_WT, min_expr = 0.1)
```

```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT", "gbm_cds_WT", "Gene.Trend", "Plot.Genes.trend")])
gc()
```

# Pseudotime in the KO

```{r}
KO <- readRDS("./GmncKO.cells.RDS") %>% subset(idents = c(6:9), invert = T)
```

## Compute differentiation states scores

### AP

```{r}
APgenes <- c("Rgcc", "Sparc", "Hes5","Hes1", "Slc1a3",
             "Ddah1", "Ldha", "Hmga2","Sfrp1", "Id4",
             "Creb5", "Ptn", "Lpar1", "Rcn1","Zfp36l1",
             "Sox9", "Sox2", "Nr2e1", "Ttyh1", "Trip6")

KO <- AddModuleScore(KO,
                     features = list(APgenes),
                     name = "AP_signature")
```

### BP

```{r}
BPgenes <- c("Eomes", "Igsf8", "Insm1", "Elavl2", "Elavl4",
             "Hes6","Gadd45g", "Neurog2", "Btg2", "Neurog1")

KO <- AddModuleScore(KO,
                     features = list(BPgenes),
                     name = "BP_signature")
```

### EN

```{r}
ENgenes <- c("Mfap4", "Nhlh2", "Nhlh1", "Ppp1r14a", "Nav1",
             "Neurod1", "Sorl1", "Svip", "Cxcl12", "Tenm4",
             "Dll3", "Rgmb", "Cntn2", "Vat1")

KO <- AddModuleScore(KO,
                     features = list(ENgenes),
                     name = "EN_signature")
```

### LN

```{r}
LNgenes <- c("Snhg11", "Pcsk1n", "Mapt", "Ina", "Stmn4",
             "Gap43", "Tubb2a", "Ly6h","Ptprd", "Mef2c")

KO <- AddModuleScore(KO,
                     features = list(LNgenes),
                     name = "LN_signature")
```

```{r}
FeaturePlot(object = KO,
            features = c("AP_signature1", "BP_signature1",
                              "EN_signature1", "LN_signature1"),
            pt.size = 0.75,
            cols = rev(brewer.pal(10,"Spectral")),
            reduction = "spring",
            order = T) & NoAxes() & NoLegend()
```

## Group cells in Pallial or CR lineage

```{r}
KO$Lineage <- sapply(KO$Cell.ident,
                              FUN = function(x) {
                                if (x %in% c("Neuron_prob.2", "Hem")) {
                                  x = "Cajal-Retzius_neurons"
                                } else if (x %in% c("Neuron_prob.3", "Medial_pallium")) {
                                  x = "Pallial_neurons"
                                } else {
                                  x = "other"
                                  }
                              })
```

```{r}
DimPlot(KO,
        reduction = "spring",
        group.by = "Lineage",
        pt.size = 0.5,
        cols =  c("#cc391b","#969696","#026c9a")
        ) + NoAxes()
```

## Fit principale curve on the two lineages

```{r}
Neurons.data <-  subset(KO,  subset = Lineage %in% c("Cajal-Retzius_neurons", "Pallial_neurons") & Cell.ident %in% c("Neuron_prob.2", "Neuron_prob.3"))

DimPlot(Neurons.data ,
        reduction = "spring",
        group.by = "Lineage",
        pt.size = 1,
        cols =  c("#cc391b","#026c9a")
        ) + NoAxes()
```

```{r}
fit <- principal_curve(as.matrix(Neurons.data@meta.data[,c("Spring_1", "Spring_2")]),
                       smoother='lowess',
                       trace=TRUE,
                       f = 1,
                       stretch=0)
```

```{r}
#Pseudotime score
PseudotimeScore <- fit$lambda/max(fit$lambda)

if (cor(PseudotimeScore, Neurons.data@assays$SCT@data['Hmga2', ]) > 0) {
  Neurons.data$PseudotimeScore <- -(PseudotimeScore - max(PseudotimeScore))
}

cols <- brewer.pal(n =11, name = "Spectral")

ggplot(Neurons.data@meta.data, aes(Spring_1, Spring_2)) +
  geom_point(aes(color=PseudotimeScore), size=2, shape=16) + 
  scale_color_gradientn(colours=rev(cols), name='Pseudotime score')
```

### Plot pan-neuronal genes along this axis

```{r}
Neurons.data <- NormalizeData(Neurons.data, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r fig.dim=c(9,10)}
Trajectories.neurons <- Neurons.data@meta.data %>% select(Barcodes, Spring_1, Spring_2,
                                                          AP_signature1, BP_signature1, EN_signature1, LN_signature1,
                                                          Lineage, PseudotimeScore)

# Neurog2
p1 <- FeaturePlot(object = Neurons.data,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons$Neurog2 <- Neurons.data@assays$RNA@data["Neurog2", Trajectories.neurons$Barcodes]

p2 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()
Trajectories.neurons$Tbr1 <- Neurons.data@assays$RNA@data["Tbr1", Trajectories.neurons$Barcodes]

p4 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons$Mapt <- Neurons.data@assays$RNA@data["Mapt", Trajectories.neurons$Barcodes]

p6 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```

### Shift pseudotime score

```{r}
score <- sapply(Trajectories.neurons$PseudotimeScore,
                FUN = function(x) if (x <= 0.15) {x= 0.15} else { x=x })

Trajectories.neurons$PseudotimeScore.shifted <- (score - min(score)) / (max(score) - min(score))
```

```{r}
# Neurog2
p1 <- FeaturePlot(object = Neurons.data ,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p4 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p6 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```


```{r}
Trajectories.neurons$nUMI <- Neurons.data$nCount_RNA

ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= nUMI/10000)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)
```

## Fit cell cycle trajectory on progenitors

To balance the number of progenitors in both domain we will only work with *Hem* and *Medial_pallium* annotated cells. Since we are using pallial cell to contrast CR specific trajectory we think this approximation will not significantly affect our analysis.

```{r}
Progenitors.data <-  subset(KO,  subset = Lineage %in% c("Cajal-Retzius_neurons", "Pallial_neurons") & Cell.ident %in% c("Hem", "Medial_pallium"))

DimPlot(Progenitors.data,
        reduction = "spring",
        group.by = "Cell.ident",
        pt.size = 1,
        cols =  c("#cc391b","#026c9a")
        ) + NoAxes()
```

```{r}
table(Progenitors.data$Cell.ident)
```

```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT", "gbm_cds_WT", "Trajectories.neurons", "Progenitors.data")])
gc()
```

### Prepare data for Revelio

```{r}
rawCounts <- as.matrix(Progenitors.data[["RNA"]]@counts)

# Filter genes expressed by less than 10 cells
num.cells <- Matrix::rowSums(rawCounts > 0)
genes.use <- names(x = num.cells[which(x = num.cells >= 10)])
rawCounts <- rawCounts[genes.use, ]
```

### Run Revelio

```{r}
CCgenes <- read.table("../ChoroidPlexus_trajectory/CCgenes.csv", sep = ";", header = T)
```

We can now follow the tutorial form the [package github page](https://github.com/danielschw188/Revelio)


```{r}
myData <- createRevelioObject(rawData = rawCounts,
                              cyclicGenes = CCgenes,
                              lowernGeneCutoff = 0,
                              uppernUMICutoff = Inf,
                              ccPhaseAssignBasedOnIndividualBatches = F)

rm("rawCounts")
gc()
```

The getCellCyclePhaseAssignInformation filter “outlier” cells for cell cycle phase assignation. We modified the function to keep all cells as we observed this does not affect the global cell cycle fitting procedure

```{r}
source("../Functions/functions_InitializationCCPhaseAssignFiltering.R")

myData <- getCellCyclePhaseAssign_allcells(myData)
```

```{r}
myData <- getPCAData(dataList = myData)

myData <- getOptimalRotation(dataList = myData)
```

### Graphical assesment of cell cycle fitting

```{r}
CellCycledata <- cbind(as.data.frame(t(myData@transformedData$dc$data[1:2,])),
                       nUMI= myData@cellInfo$nUMI,
                       Revelio.phase = factor(myData@cellInfo$ccPhase, levels = c("G1.S", "S", "G2", "G2.M", "M.G1")),
                       Revelio.cc= myData@cellInfo$ccPercentageUniformlySpaced,
                       Domain= Progenitors.data$Cell.ident)
```

```{r}
p1 <- ggplot(CellCycledata, aes(DC1, DC2)) +
        geom_point(aes(color = Revelio.phase), size= 0.5) +
        scale_color_manual(values= c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5]))

p2 <- ggplot(CellCycledata, aes(DC1, DC2)) +
        geom_point(aes(color = Domain), size = 0.5) +
        scale_color_manual(values= c("#cc391b","#026c9a"))

p3 <- ggplot(CellCycledata, aes(DC1, DC2)) +
        geom_point(aes(color=Revelio.cc), size=0.5, shape=16) + 
        scale_color_gradientn(colours=rev(colorRampPalette(brewer.pal(n =11, name = "Spectral"))(100)),
                              name='Revelio_cc')

p4 <- ggplot(CellCycledata, aes(x= Revelio.cc, y= nUMI/10000)) +
        geom_point(aes(color= Revelio.phase), size=0.5) +
        scale_color_manual(values= c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) +
        geom_smooth(method="loess", n= 50, fill="grey") +
        ylim(0,NA)

(p1 + p2) /(p3 + p4)
```

```{r}
Progenitors.data$Revelio.phase <- CellCycledata$Revelio.phase
Progenitors.data$Revelio.cc <- CellCycledata$Revelio.cc

p1 <- FeaturePlot(object = Progenitors.data,
                  features = "Revelio.cc",
                  pt.size = 1,
                  cols = rev(brewer.pal(10,"Spectral")),
                  reduction = "spring",
                  order = T) & NoAxes()

p2 <- DimPlot(object = Progenitors.data,
              group.by = "Revelio.phase",
              pt.size = 1,
              reduction = "spring",
              cols =  c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) & NoAxes()

p1 / p2
```

### Transfert learn cell cycle axis

```{r}
Progenitors <- Progenitors.data@meta.data %>% select(Barcodes, Spring_1, Spring_2,
                                                     AP_signature1, BP_signature1, EN_signature1, LN_signature1,
                                                     Lineage)

Progenitors$PseudotimeScore <- CellCycledata$Revelio.cc
Progenitors$nUMI <- Progenitors.data$nCount_RNA
```

## Combine Progenitors and differentiating neurons data

```{r}
# Start with neurons data
Trajectories.all <- Trajectories.neurons %>% select(Barcodes, nUMI, Spring_1, Spring_2, AP_signature1, BP_signature1, EN_signature1, LN_signature1, Lineage)

Trajectories.all$Pseudotime <- Trajectories.neurons$PseudotimeScore.shifted + 0.5
Trajectories.all$Phase <- NA
```

```{r}
# Add progenitors data
Trajectories.progenitors <- Progenitors %>%
                              select(Barcodes, nUMI, Spring_1, Spring_2, AP_signature1, BP_signature1, EN_signature1, LN_signature1, Lineage) %>% 
                              mutate(Pseudotime= Progenitors.data$Revelio.cc/2,
                                     Phase = Progenitors.data$Revelio.phase)
```

```{r}
Trajectories.all <- rbind(Trajectories.all, Trajectories.progenitors)

Trajectories.all$Phase <- factor(Trajectories.all$Phase, levels = c("G1.S", "S", "G2", "G2.M", "M.G1"))
```

```{r}
p1 <- ggplot(Trajectories.all, aes(Spring_1, Spring_2)) +
        geom_point(aes(color=Pseudotime), size=0.5) + 
        scale_color_gradientn(colours=rev(brewer.pal(n =11, name = "Spectral")), name='Pseudotime score')

p2 <- ggplot(Trajectories.all, aes(Spring_1, Spring_2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a"))

p1 + p2
```

```{r}
p1 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= nUMI/10000)) +
        geom_point(aes(color= Phase), size=0.5) +
        scale_color_manual(values= c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) +
        geom_smooth(method="loess", n= 50, fill="grey") +
        ylim(0,NA)

p2 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= nUMI/10000)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(aes(color= Lineage), method="loess", n= 50, fill="grey") +
        ylim(0,NA)

p1 / p2
```


```{r}
p1 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= AP_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(aes(color= Lineage), method="loess", n= 50, fill="grey")


p2 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= BP_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(aes(color= Lineage), method="loess", n= 50, fill="grey")

p3 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= EN_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(aes(color= Lineage), method="loess", n= 50, fill="grey")

p4 <- ggplot(Trajectories.all, aes(x= Pseudotime, y= LN_signature1)) +
  geom_point(aes(color= Lineage), size=0.5) +
  scale_color_manual(values= c("#cc391b", "#026c9a")) +
  geom_smooth(aes(color= Lineage), method="loess", n= 50, fill="grey")


p1 / p2 / p3 / p4
```

### Subset the full Seurat object

```{r}
KO <- readRDS("./GmncKO.cells.RDS") %>% subset(idents = c(6:9), invert = T)
```

```{r}
Neuro.trajectories_KO <- CreateSeuratObject(counts = KO@assays$RNA@data[, Trajectories.all$Barcodes],
                                            meta.data = Trajectories.all)

spring <- as.matrix(Neuro.trajectories_KO@meta.data %>% select("Spring_1", "Spring_2"))
  
Neuro.trajectories_KO[["spring"]] <- CreateDimReducObject(embeddings = spring, key = "Spring_", assay = DefaultAssay(Neuro.trajectories_KO))
```

```{r}
p1 <- FeaturePlot(object = Neuro.trajectories_KO,
            features = "Pseudotime",
            pt.size = 0.5,
            cols = rev(colorRampPalette(brewer.pal(n =11, name = "Spectral"))(100)),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- DimPlot(object = Neuro.trajectories_KO,
        group.by = "Lineage",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c("#cc391b", "#026c9a")) & NoAxes()


p3 <- DimPlot(object = Neuro.trajectories_KO,
        group.by = "Phase",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) & NoAxes()

p1 + p2 + p3
```

### Normalization

```{r}
Neuro.trajectories_KO <- NormalizeData(Neuro.trajectories_KO, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r}
Neuro.trajectories_KO <- FindVariableFeatures(Neuro.trajectories_KO, selection.method = "disp", nfeatures = 3000, assay = "RNA")
```

### Plot some genes along pseudotime

```{r fig.dim=c(9,8)}
source("../Functions/functions_GeneTrends.R")

Plot.Genes.trend(Seurat.data= Neuro.trajectories_KO,
                 group.by = "Lineage",
                 genes= c("Gas1","Sox2",
                          "Neurog2", "Btg2",
                          "Tbr1", "Mapt",
                          "Trp73", "Foxg1"))
```

```{r fig.dim=c(9,6)}
Plot.Genes.trend(Seurat.data= Neuro.trajectories_KO,
                 group.by = "Lineage",
                 genes= c("Gmnc", "Mcidas",
                          "Ccno", "Ccdc67",
                          "Foxj1", "Trp73",
                          "Lhx1", "Cdkn1a"))
```

## Use monocle2 to model gene expression along cycling axis

```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT", "gbm_cds_WT", "Neuro.trajectories_KO")])
gc()
```

### Initialize a monocle object

```{r}
# Transfer metadata
Annot.data  <- new('AnnotatedDataFrame',
                   data = data.frame(Barcode= Neuro.trajectories_KO$Barcodes,
                          Lineage= Neuro.trajectories_KO$Lineage,
                          Pseudotime= Neuro.trajectories_KO$Pseudotime,
                          Phase= Neuro.trajectories_KO$Phase))

# Transfer counts data
var.genes <- Neuro.trajectories_KO[["RNA"]]@var.features

feature.data <- new('AnnotatedDataFrame',
                    data = data.frame(gene_short_name = rownames(Neuro.trajectories_KO[["RNA"]]@data),
                           row.names = rownames(Neuro.trajectories_KO[["RNA"]]@data)))

# Create the CellDataSet object including variable genes only
gbm_cds_KO <- newCellDataSet(Neuro.trajectories_KO[["RNA"]]@counts,
                              phenoData = Annot.data,
                              featureData = feature.data,
                              lowerDetectionLimit = 0,
                              expressionFamily = negbinomial())
```

```{r message=FALSE, warning=FALSE, cache=TRUE}
gbm_cds_KO <- estimateSizeFactors(gbm_cds_KO)
gbm_cds_KO <- estimateDispersions(gbm_cds_KO)
gbm_cds_KO <- detectGenes(gbm_cds_KO, min_expr = 0.1)
```

```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT","Neuro.trajectories_KO", "gbm_cds_WT", "gbm_cds_KO", "Gene.Trend", "Plot.Genes.trend")])
gc()
```
# Find DEG among all WT and KO trajectories

## WT DEG

```{r}
num.cells <- Matrix::rowSums(Neuro.trajectories_WT@assays$RNA@counts > 0)
n.expressed <- names(x = num.cells[which(x = num.cells >= 200)])

Input.genes <- rownames(gbm_cds_WT)[rownames(gbm_cds_WT) %in% n.expressed]
```


```{r  message=FALSE, warning=FALSE, cache=TRUE}
WT.genes <- differentialGeneTest(gbm_cds_WT[Input.genes, ], 
                                 fullModelFormulaStr = "~sm.ns(Pseudotime, df = 3)", 
                                 reducedModelFormulaStr = "~1", 
                                 cores = parallel::detectCores() - 2)

#Filter based on FDR
WT.genes.filtered <- WT.genes  %>% filter(qval < 1e-100)
```

## KO DEG

```{r}
num.cells <- Matrix::rowSums(Neuro.trajectories_KO@assays$RNA@counts > 0)
n.expressed <- names(x = num.cells[which(x = num.cells >= 200)])

Input.genes <- rownames(gbm_cds_KO)[rownames(gbm_cds_KO) %in% n.expressed]
```


```{r  message=FALSE, warning=FALSE, cache=TRUE}
KO.genes <- differentialGeneTest(gbm_cds_KO[Input.genes, ], 
                                 fullModelFormulaStr = "~sm.ns(Pseudotime, df = 3)", 
                                 reducedModelFormulaStr = "~1", 
                                 cores = parallel::detectCores() - 2)

#Filter based on FDR
KO.genes.filtered <- KO.genes  %>% filter(qval < 1e-100)
```

# Correlation between trajectories

```{r}
WT_KO_DEG <- union(KO.genes.filtered$gene_short_name, WT.genes.filtered$gene_short_name)

TFs <- read.table("TF.csv", sep = ";")[,1]
Input.TFs <- intersect(rownames(gbm_cds_KO)[rownames(gbm_cds_KO) %in% TFs], rownames(gbm_cds_WT)[rownames(gbm_cds_WT) %in% TFs])
```

```{r cache=TRUE}
# Create a new pseudo-DV vector of 100 points
nPoints <- 100

# Smooth gene expression along pseudo-maturation axis
new_data = list()
for (Lineage in unique(pData(gbm_cds_WT)$Lineage)){
  new_data[[length(new_data) + 1]] = data.frame(Pseudotime = seq(min(pData(gbm_cds_WT)$Pseudotime),
                                                                 max(pData(gbm_cds_WT)$Pseudotime),
                                                                 length.out = nPoints),
                                                Lineage=Lineage)
}

new_data = do.call(rbind, new_data)


WT.smooth.curve.matrix <- genSmoothCurves(gbm_cds_WT[Input.TFs,],
                                              trend_formula =  "~sm.ns(Pseudotime, df = 3)*Lineage",
                                              relative_expr = TRUE,
                                              new_data = new_data,
                                              cores= parallel::detectCores() - 2)

# Smooth gene expression along pseudo-maturation axis
new_data = list()
for (Lineage in unique(pData(gbm_cds_KO)$Lineage)){
  new_data[[length(new_data) + 1]] = data.frame(Pseudotime = seq(min(pData(gbm_cds_KO)$Pseudotime),
                                                                 max(pData(gbm_cds_KO)$Pseudotime),
                                                                 length.out = nPoints),
                                                Lineage=Lineage)
}

new_data = do.call(rbind, new_data)


KO.smooth.curve.matrix <- genSmoothCurves(gbm_cds_KO[Input.TFs,],
                                              trend_formula =  "~sm.ns(Pseudotime, df = 3)*Lineage",
                                              relative_expr = TRUE,
                                              new_data = new_data,
                                              cores= parallel::detectCores() - 2)
```

## Pallial neurons correlation

```{r}
Smoothed.point.cor <- pdist::pdist(X= scale(t(KO.smooth.curve.matrix[,1:100])),
                                   Y= scale(t(WT.smooth.curve.matrix[,1:100])))

Smoothed.point.cor <- as.matrix(Smoothed.point.cor)
rownames(Smoothed.point.cor) <- 1:100
colnames(Smoothed.point.cor) <- 1:100

anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"))
anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), c(33,67)))
rownames(anno) <- 1:100

p1 <- pheatmap::pheatmap(Smoothed.point.cor,
         cluster_rows = F,
         cluster_cols = F,
         border_color = NA,
         annotation_row = anno,
         annotation_col = anno,
         annotation_colors = anno.colors,
         show_colnames = F,
         show_rownames = F,
         color = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(50),
         main = "Pallial KO vs Pallial WT euclidian dist",
         legend = F,
         annotation_legend =F)
```

```{r}
Smoothed.point.cor <- pdist::pdist(X= scale(t(KO.smooth.curve.matrix[,101:200])),
                                   Y= scale(t(WT.smooth.curve.matrix[,101:200])))

Smoothed.point.cor <- as.matrix(Smoothed.point.cor)
rownames(Smoothed.point.cor) <- 1:100
colnames(Smoothed.point.cor) <- 1:100

anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"))
anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), c(33,67)))
rownames(anno) <- 1:100

p2 <- pheatmap::pheatmap(Smoothed.point.cor,
         cluster_rows = F,
         cluster_cols = F,
         border_color = NA,
         annotation_row = anno,
         annotation_col = anno,
         annotation_colors = anno.colors,
         show_colnames = F,
         show_rownames = F,
         color = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100),
         main = "CR KO vs CR WT euclidian dist",
         legend = F,
         annotation_legend =F)
```
```{r}
Smoothed.point.cor <- pdist::pdist(X= scale(t(WT.smooth.curve.matrix[,101:200])),
                                   Y= scale(t(WT.smooth.curve.matrix[,1:100])))

Smoothed.point.cor <- as.matrix(Smoothed.point.cor)
rownames(Smoothed.point.cor) <- 1:100
colnames(Smoothed.point.cor) <- 1:100

anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"))
anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), c(33,67)))
rownames(anno) <- 1:100

p3 <- pheatmap::pheatmap(Smoothed.point.cor,
         cluster_rows = F,
         cluster_cols = F,
         border_color = NA,
         annotation_row = anno,
         annotation_col = anno,
         annotation_colors = anno.colors,
         show_colnames = F,
         show_rownames = F,
         color = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100),
         main = "CR WT vs Pallial WT euclidian dist",
         legend = F,
         annotation_legend =F)
```
```{r}
Smoothed.point.cor <- pdist::pdist(X= scale(t(KO.smooth.curve.matrix[,101:200])),
                                   Y= scale(t(WT.smooth.curve.matrix[,1:100])))

Smoothed.point.cor <- as.matrix(Smoothed.point.cor)
rownames(Smoothed.point.cor) <- 1:100
colnames(Smoothed.point.cor) <- 1:100

anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"))
anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), c(33,67)))
rownames(anno) <- 1:100

p4 <- pheatmap::pheatmap(Smoothed.point.cor,
         cluster_rows = F,
         cluster_cols = F,
         border_color = NA,
         annotation_row = anno,
         annotation_col = anno,
         annotation_colors = anno.colors,
         show_colnames = F,
         show_rownames = F,
         color = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100),
         main = "CR KO vs Pallial WT euclidian dist",
         legend = F,
         annotation_legend =F)
```

```{r}
Smoothed.point.cor <- pdist::pdist(X= scale(t(WT.smooth.curve.matrix[,101:200])),
                                   Y= scale(t(WT.smooth.curve.matrix[,101:200])))

Smoothed.point.cor <- as.matrix(Smoothed.point.cor)
rownames(Smoothed.point.cor) <- 1:100
colnames(Smoothed.point.cor) <- 1:100

anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"))
anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), c(33,67)))
rownames(anno) <- 1:100

p5 <- pheatmap::pheatmap(Smoothed.point.cor,
         cluster_rows = F,
         cluster_cols = F,
         border_color = NA,
         annotation_row = anno,
         annotation_col = anno,
         annotation_colors = anno.colors,
         show_colnames = F,
         show_rownames = F,
         color = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100),
         main = "CR WT vs CR WT euclidian dist",
         legend = F,
         annotation_legend =F)
```

```{r}
Smoothed.point.cor <- pdist::pdist(X= scale(t(WT.smooth.curve.matrix[,1:100])),
                                   Y= scale(t(WT.smooth.curve.matrix[,1:100])))

Smoothed.point.cor <- as.matrix(Smoothed.point.cor)
rownames(Smoothed.point.cor) <- 1:100
colnames(Smoothed.point.cor) <- 1:100

anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"))
anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), c(33,67)))
rownames(anno) <- 1:100

p6 <- pheatmap::pheatmap(Smoothed.point.cor,
         cluster_rows = F,
         cluster_cols = F,
         border_color = NA,
         annotation_row = anno,
         annotation_col = anno,
         annotation_colors = anno.colors,
         show_colnames = F,
         show_rownames = F,
         color = colorRampPalette(brewer.pal(n = 10, name = "RdBu"))(100),
         main = "CR WT vs CR WT euclidian dist",
         legend = F,
         annotation_legend =F)
```

```{r}
cowplot::plot_grid(p1$gtable, p2$gtable, p3$gtable, p4$gtable, p5$gtable, p6$gtable,
                   ncol = 2,
                   align = "v",
                   rel_heights = c(1,1),
                   greedy = T)
```


# Session Info

```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```