---
title: "Comparison between trajectories in the Gmnc WT/KO"
author:
   - Matthieu Moreau^[Institute of Psychiatry and Neuroscience of Paris, INSERM U1266, 75014, Paris, France, matthieu.moreau@inserm.fr] [![](https://orcid.org/sites/default/files/images/orcid_16x16.png)](https://orcid.org/0000-0002-2592-2373)
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_download: yes
    df_print: tibble
    highlight: haddock
    theme: cosmo
    css: "../style.css"
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message=FALSE, warning=FALSE, cache.lazy = FALSE)

# To use biomart 
new_config <- httr::config(ssl_verifypeer = FALSE)
httr::set_config(new_config, override = FALSE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(princurve)
library(Revelio)
library(monocle)
library(gprofiler2)
library(seriation)
library(Matrix)
library(dplyr)
library(RColorBrewer)
library(fungible)
library(ggplot2)
library(ggExtra)
library(cowplot)
library(wesanderson)

#Set ggplot theme as classic
theme_set(theme_classic())
```

# Pseudotime in the WT

```{r}
WT <- readRDS("../QC.filtered.clustered.cells.RDS")
```

## Extract CR and CP neurons 
```{r}
WT$Lineage <- sapply(WT$Cell_ident,
                              FUN = function(x) {
                                if (x %in% c("Cajal-Retzius_neurons", "Hem")) {
                                  x = "Cajal-Retzius_neurons"
                                } else if (x %in% c("Pallial_neurons", "Medial_pallium")) {
                                  x = "Pallial_neurons"
                                } else if(x %in% c("ChP", "ChP_progenitors")) {
                                   x =  "Choroid_Plexus"
                                } else {
                                  x = "other"
                                  }
                              })
```

```{r}
Neurons.data <-  subset(WT, idents = c("Cajal-Retzius_neurons", "Pallial_neurons"))

DimPlot(Neurons.data,
        reduction = "spring",
        pt.size = 1,
        cols =  c("#cc391b","#026c9a")
        ) + NoAxes()

rm(WT)
```
## Fit principale curve on the two lineages

### Cajal-Retzius cells

```{r}
Trajectories.Hem <- Neurons.data@meta.data %>%
                    select("Barcodes", "nUMI", "Spring_1", "Spring_2", "AP_signature1","BP_signature1", "EN_signature1", "LN_signature1", "Lineage") %>%
                    filter(Lineage == "Cajal-Retzius_neurons")
```

```{r}
fit <- principal_curve(as.matrix(Trajectories.Hem[,c("Spring_1", "Spring_2")]),
                       smoother='lowess',
                       trace=TRUE,
                       f = .7,
                       stretch=0)

#The principal curve smoothed
Hem.pc.line <- as.data.frame(fit$s[order(fit$lambda),]) 

#Pseudotime score
Trajectories.Hem$PseudotimeScore <- fit$lambda/max(fit$lambda)

```

```{r}
if (cor(Trajectories.Hem$PseudotimeScore, Neurons.data@assays$SCT@data['Hmga2', Trajectories.Hem$Barcodes]) > 0) {
  Trajectories.Hem$PseudotimeScore <- -(Trajectories.Hem$PseudotimeScore - max(Trajectories.Hem$PseudotimeScore))
}
```

### Pallial neurons

```{r}
Trajectories.Pallial <- Neurons.data@meta.data %>%
                        select("Barcodes", "nUMI", "Spring_1", "Spring_2", "AP_signature1","BP_signature1", "EN_signature1", "LN_signature1", "Lineage") %>%
                        filter(Lineage == "Pallial_neurons")
                  
```

```{r}
fit <- principal_curve(as.matrix(Trajectories.Pallial[,c("Spring_1", "Spring_2")]),
                       smoother='lowess',
                       trace=TRUE,
                       f = .7,
                       stretch=0)

#The principal curve smoothed
Pallial.pc.line <- as.data.frame(fit$s[order(fit$lambda),])

#Pseudotime score
Trajectories.Pallial$PseudotimeScore <- fit$lambda/max(fit$lambda)
```

```{r}
if (cor(Trajectories.Pallial$PseudotimeScore, Neurons.data@assays$SCT@data['Hmga2', Trajectories.Pallial$Barcodes]) > 0) {
  Trajectories.Pallial$PseudotimeScore <- -(Trajectories.Pallial$PseudotimeScore - max(Trajectories.Pallial$PseudotimeScore))
}
```

### Combine the two trajectories' data

```{r}
Trajectories.neurons.WT <- rbind(Trajectories.Pallial, Trajectories.Hem)
```

```{r}
cols <- brewer.pal(n =11, name = "Spectral")

ggplot(Trajectories.neurons.WT, aes(Spring_1, Spring_2)) +
  geom_point(aes(color=PseudotimeScore), size=2, shape=16) + 
  scale_color_gradientn(colours=rev(cols), name='Speudotime score') +
  geom_line(data=Pallial.pc.line, color="#026c9a", size=0.77) +
  geom_line(data=Hem.pc.line, color="#cc391b", size=0.77)
```

### Plot pan-neuronal genes along this axis

```{r}
Neurons.data <- NormalizeData(Neurons.data, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r fig.dim=c(9,10)}
# Neurog2
p1 <- FeaturePlot(object = Neurons.data,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons.WT$Neurog2 <- Neurons.data@assays$RNA@data["Neurog2", Trajectories.neurons.WT$Barcodes]

p2 <- ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()
Trajectories.neurons.WT$Tbr1 <- Neurons.data@assays$RNA@data["Tbr1", Trajectories.neurons.WT$Barcodes]

p4 <- ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons.WT$Mapt <- Neurons.data@assays$RNA@data["Mapt", Trajectories.neurons.WT$Barcodes]

p6 <- ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```

### Shift Pseudotime in both lineage

Since we observe the first 25% of both trajectories are occupied by few, likely progenitor cells, we shift this cell along the axis

```{r}
Pseudotime.intervals <- Trajectories.neurons.WT%>%
                          select(Lineage, PseudotimeScore) %>%
                          mutate(Pseudotime.bins = cut(Trajectories.neurons.WT$PseudotimeScore, seq(0, max(Trajectories.neurons.WT$PseudotimeScore) + 0.05, 0.05), dig.lab = 2, right = FALSE)) %>%
                          group_by(Lineage, Pseudotime.bins) %>%
                          summarise(n=n())

ggplot(Pseudotime.intervals, aes(x=Pseudotime.bins, y=n, fill=Lineage)) +
        geom_bar(stat = "identity", width = 0.90) +
        theme(axis.text.x = element_text(angle = 45, hjust=1))+
        scale_fill_manual(values= c("#cc391b", "#026c9a"))
```

```{r}
score <- sapply(Trajectories.neurons.WT$PseudotimeScore,
                FUN = function(x) if (x <= 0.2) {x= 0.2} else { x=x })

Trajectories.neurons.WT$PseudotimeScore.shifted <- (score - min(score)) / (max(score) - min(score))
```

```{r fig.dim=c(9,10)}
# Neurog2
p1 <- FeaturePlot(object = Neurons.data ,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore.shifted, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p4 <- ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore.shifted, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p6 <- ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore.shifted, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```

```{r}
ggplot(Trajectories.neurons.WT, aes(x= PseudotimeScore.shifted, y= nUMI/10000)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)
```

```{r}
Hem.data <- readRDS("../QC.filtered.clustered.cells.RDS")
```

```{r}
Trajectories.neurons.WT$Pseudotime <- Trajectories.neurons.WT$PseudotimeScore.shifted

Neuro.trajectories_WT <- CreateSeuratObject(counts = Hem.data@assays$RNA@data[, Trajectories.neurons.WT$Barcodes],
                                            meta.data = Trajectories.neurons.WT)

spring <- as.matrix(Neuro.trajectories_WT@meta.data %>% select("Spring_1", "Spring_2"))
  
Neuro.trajectories_WT[["spring"]] <- CreateDimReducObject(embeddings = spring, key = "Spring_", assay = DefaultAssay(Neuro.trajectories_WT))
```

```{r fig.dim=c(6, 12)}
p1 <- FeaturePlot(object = Neuro.trajectories_WT,
            features = "Pseudotime",
            pt.size = 0.5,
            cols = rev(colorRampPalette(brewer.pal(n =11, name = "Spectral"))(100)),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- DimPlot(object = Neuro.trajectories_WT,
        group.by = "Lineage",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c("#cc391b", "#026c9a")) & NoAxes()

p1 + p2
```

```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT")])
```


# Pseudotime in the KO

```{r}
KO <- readRDS("./GmncKO.cells.RDS") %>% subset(idents = c(6:9), invert = T)
```

## Compute differentiation states scores

AP

```{r}
APgenes <- c("Rgcc", "Sparc", "Hes5","Hes1", "Slc1a3",
             "Ddah1", "Ldha", "Hmga2","Sfrp1", "Id4",
             "Creb5", "Ptn", "Lpar1", "Rcn1","Zfp36l1",
             "Sox9", "Sox2", "Nr2e1", "Ttyh1", "Trip6")

KO <- AddModuleScore(KO,
                     features = list(APgenes),
                     name = "AP_signature")
```

BP

```{r}
BPgenes <- c("Eomes", "Igsf8", "Insm1", "Elavl2", "Elavl4",
             "Hes6","Gadd45g", "Neurog2", "Btg2", "Neurog1")

KO <- AddModuleScore(KO,
                     features = list(BPgenes),
                     name = "BP_signature")
```

EN

```{r}
ENgenes <- c("Mfap4", "Nhlh2", "Nhlh1", "Ppp1r14a", "Nav1",
             "Neurod1", "Sorl1", "Svip", "Cxcl12", "Tenm4",
             "Dll3", "Rgmb", "Cntn2", "Vat1")

KO <- AddModuleScore(KO,
                     features = list(ENgenes),
                     name = "EN_signature")
```

LN

```{r}
LNgenes <- c("Snhg11", "Pcsk1n", "Mapt", "Ina", "Stmn4",
             "Gap43", "Tubb2a", "Ly6h","Ptprd", "Mef2c")

KO <- AddModuleScore(KO,
                     features = list(LNgenes),
                     name = "LN_signature")
```

```{r}
FeaturePlot(object = KO,
            features = c("AP_signature1", "BP_signature1",
                              "EN_signature1", "LN_signature1"),
            pt.size = 0.75,
            cols = rev(brewer.pal(10,"Spectral")),
            reduction = "spring",
            order = T) & NoAxes() & NoLegend()
```

## Group cells in Pallial or CR lineage

```{r}
KO$Lineage <- sapply(KO$Cell.ident,
                              FUN = function(x) {
                                if (x %in% c("Neuron_prob.2", "Hem")) {
                                  x = "Cajal-Retzius_neurons"
                                } else if (x %in% c("Neuron_prob.3", "Medial_pallium")) {
                                  x = "Pallial_neurons"
                                } else {
                                  x = "other"
                                  }
                              })
```

```{r}
DimPlot(KO,
        reduction = "spring",
        group.by = "Lineage",
        pt.size = 0.5,
        cols =  c("#cc391b","#969696","#026c9a")
        ) + NoAxes()
```

## Fit principale curve on the two lineages

```{r}
Neurons.data <-  subset(KO,  subset = Lineage %in% c("Cajal-Retzius_neurons", "Pallial_neurons") & Cell.ident %in% c("Neuron_prob.2", "Neuron_prob.3"))

DimPlot(Neurons.data ,
        reduction = "spring",
        group.by = "Lineage",
        pt.size = 1,
        cols =  c("#cc391b","#026c9a")
        ) + NoAxes()
```

```{r}
fit <- principal_curve(as.matrix(Neurons.data@meta.data[,c("Spring_1", "Spring_2")]),
                       smoother='lowess',
                       trace=TRUE,
                       f = 1,
                       stretch=0)
```

```{r}
#Pseudotime score
PseudotimeScore <- fit$lambda/max(fit$lambda)

if (cor(PseudotimeScore, Neurons.data@assays$SCT@data['Hmga2', ]) > 0) {
  Neurons.data$PseudotimeScore <- -(PseudotimeScore - max(PseudotimeScore))
}

cols <- brewer.pal(n =11, name = "Spectral")

ggplot(Neurons.data@meta.data, aes(Spring_1, Spring_2)) +
  geom_point(aes(color=PseudotimeScore), size=2, shape=16) + 
  scale_color_gradientn(colours=rev(cols), name='Pseudotime score')
```

### Plot pan-neuronal genes along this axis

```{r}
Neurons.data <- NormalizeData(Neurons.data, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r fig.dim=c(9,10)}
Trajectories.neurons <- Neurons.data@meta.data %>% select(Barcodes, Spring_1, Spring_2,
                                                          AP_signature1, BP_signature1, EN_signature1, LN_signature1,
                                                          Lineage, PseudotimeScore)

# Neurog2
p1 <- FeaturePlot(object = Neurons.data,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons$Neurog2 <- Neurons.data@assays$RNA@data["Neurog2", Trajectories.neurons$Barcodes]

p2 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()
Trajectories.neurons$Tbr1 <- Neurons.data@assays$RNA@data["Tbr1", Trajectories.neurons$Barcodes]

p4 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

Trajectories.neurons$Mapt <- Neurons.data@assays$RNA@data["Mapt", Trajectories.neurons$Barcodes]

p6 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```

### Shift pseudotime score

```{r}
score <- sapply(Trajectories.neurons$PseudotimeScore,
                FUN = function(x) if (x <= 0.15) {x= 0.15} else { x=x })

Trajectories.neurons$PseudotimeScore.shifted <- (score - min(score)) / (max(score) - min(score))
```

```{r}
# Neurog2
p1 <- FeaturePlot(object = Neurons.data ,
            features = c("Neurog2"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Neurog2)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Tbr1 
p3 <- FeaturePlot(object = Neurons.data ,
            features = c("Tbr1"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p4 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Tbr1)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

# Mapt 
p5 <- FeaturePlot(object = Neurons.data ,
            features = c("Mapt"),
            pt.size = 0.5,
            cols = c("grey90", brewer.pal(9,"YlGnBu")),
            reduction = "spring",
            order = T) & NoAxes()

p6 <- ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= Mapt)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)

p1 + p2 + p3 + p4 + p5 + p6 + patchwork::plot_layout(ncol = 2)
```


```{r}
Trajectories.neurons$nUMI <- Neurons.data$nCount_RNA

ggplot(Trajectories.neurons, aes(x= PseudotimeScore.shifted, y= nUMI/10000)) +
        geom_point(aes(color= Lineage), size=0.5) +
        scale_color_manual(values= c("#cc391b", "#026c9a")) +
        geom_smooth(method="loess", n= 50, aes(color= Lineage)) +
        ylim(0,NA)
```

### Subset the full Seurat object

```{r}
KO <- readRDS("./GmncKO.cells.RDS") %>% subset(idents = c(6:9), invert = T)
```

```{r}
Trajectories.neurons$Pseudotime <- Trajectories.neurons$PseudotimeScore.shifted

Neuro.trajectories_KO <- CreateSeuratObject(counts = KO@assays$RNA@data[, Trajectories.neurons$Barcodes],
                                            meta.data = Trajectories.neurons)

spring <- as.matrix(Neuro.trajectories_KO@meta.data %>% select("Spring_1", "Spring_2"))
  
Neuro.trajectories_KO[["spring"]] <- CreateDimReducObject(embeddings = spring, key = "Spring_", assay = DefaultAssay(Neuro.trajectories_KO))
```

```{r}
p1 <- FeaturePlot(object = Neuro.trajectories_KO,
            features = "Pseudotime",
            pt.size = 0.5,
            cols = rev(colorRampPalette(brewer.pal(n =11, name = "Spectral"))(100)),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- DimPlot(object = Neuro.trajectories_KO,
        group.by = "Lineage",
        pt.size = 0.5,
        reduction = "spring",
        cols =  c("#cc391b", "#026c9a")) & NoAxes()

p1 + p2
```

# Cell euclidian distance along pseudotime

```{r}
rm(list = ls()[!ls() %in% c("Neuro.trajectories_WT","Neuro.trajectories_KO")])
gc()
```

## Group cells in 10 bins along pseudotime and average expression by lineage and genotype

```{r}
TFs <- read.table("TF.csv", sep = ";")[,1]
```

```{r}
WT_KO <- merge(x = Neuro.trajectories_WT, y = Neuro.trajectories_KO)

WT_KO <- NormalizeData(WT_KO, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")

WT_KO <-FindVariableFeatures(WT_KO, selection.method = "disp", nfeatures = 3000, assay = "RNA")

WT_KO  <- ScaleData(WT_KO, vars.to.regress = "nCount_RNA", features = TFs)
```

```{r}
WT_KO$Genotype <- sapply(WT_KO$orig.ident,
                              FUN = function(x) {
                                if (x %in% c("Hem1", "Hem2")) {
                                  x = "WT"
                                } else {
                                  x = "KO"
                                  }
                              })
nbreaks <- 5
WT_KO$Pseudotime.bins <- cut(WT_KO$Pseudotime, breaks = nbreaks , labels = 1:nbreaks)
```


```{r}
# WT Cajal-Retzius
WT_CR <- subset(WT_KO, subset = Genotype == "WT" & Lineage == "Cajal-Retzius_neurons")
  
WT_CR.averages <- AverageExpression(WT_CR,
                                    features = TFs,
                                    group.by = "Pseudotime.bins",
                                    slot = "scale.data")

# KO Cajal-Retzius
KO_CR <- subset(WT_KO, subset = Genotype == "KO" & Lineage == "Cajal-Retzius_neurons")

KO_CR.averages <- AverageExpression(KO_CR,
                                    features = TFs,
                                    group.by = "Pseudotime.bins",
                                    slot = "scale.data")
  
# WT Pallial neurons
WT_Pal <- subset(WT_KO, subset = Genotype == "WT" & Lineage == "Pallial_neurons")

WT_Pal.averages <- AverageExpression(WT_Pal,
                                    features = TFs,
                                    group.by = "Pseudotime.bins",
                                    slot = "scale.data")
  
# KO Pallial neurons  
KO_Pal <- subset(WT_KO, subset = Genotype == "KO" & Lineage == "Pallial_neurons")

KO_Pal.averages <- AverageExpression(KO_Pal,
                                    features = TFs,
                                    group.by = "Pseudotime.bins",
                                    slot = "scale.data")
```

## Compute correlation across conditions

```{r}
ggplot(WT_CR@meta.data, aes(Spring_1, Spring_2, color= Pseudotime.bins)) + geom_point()
```
### Distance to KO pallial neurons

```{r}
Smoothed.point.cor <- pdist::pdist(X= t(WT_CR.averages$RNA),
                                   Y= t(KO_Pal.averages$RNA))

WT_CR.dist <- diag(as.matrix(Smoothed.point.cor))

#
Smoothed.point.cor <- pdist::pdist(X= t(KO_CR.averages$RNA),
                                   Y= t(KO_Pal.averages$RNA))


KO_CR.dist <- diag(as.matrix(Smoothed.point.cor))

#
Smoothed.point.cor <- pdist::pdist(X= t(WT_Pal.averages$RNA),
                                   Y= t(KO_Pal.averages$RNA))

WT_Pal.dist <- diag(as.matrix(Smoothed.point.cor))
```

```{r}
data <- data.frame(Distance = c(WT_CR.dist, KO_CR.dist, WT_Pal.dist),
                   Trajectory = rep(c("WT_CR", "KO_CR", "WT_Pal"), each=nbreaks),
                   Pseudotime.bin = factor(rep(paste0("Bin_",1:nbreaks), 3),levels = paste0("Bin_",1:nbreaks)))

ggplot(data, aes(x= Pseudotime.bin, y= Distance, color= Trajectory, group = Trajectory)) +
  geom_line() +
  geom_point() + ggtitle("Distance to KO pallial neurons")

```
### Distance to WT pallial neurons

```{r}
Smoothed.point.cor <- pdist::pdist(X= t(WT_CR.averages$RNA),
                                   Y= t(WT_Pal.averages$RNA))

WT_CR.dist <- diag(as.matrix(Smoothed.point.cor))

#
Smoothed.point.cor <- pdist::pdist(X= t(KO_CR.averages$RNA),
                                   Y= t(WT_Pal.averages$RNA))


KO_CR.dist <- diag(as.matrix(Smoothed.point.cor))

#
Smoothed.point.cor <- pdist::pdist(X= t(KO_Pal.averages$RNA),
                                   Y= t(WT_Pal.averages$RNA))

KO_Pal.dist <- diag(as.matrix(Smoothed.point.cor))
```

```{r}
data <- data.frame(Distance = c(WT_CR.dist, KO_CR.dist, KO_Pal.dist),
                   Trajectory = rep(c("WT_CR", "KO_CR", "KO_Pal"), each=nbreaks),
                   Pseudotime.bin = factor(rep(paste0("Bin_",1:nbreaks), 3),levels = paste0("Bin_",1:nbreaks)))

ggplot(data, aes(x= Pseudotime.bin, y= Distance, color= Trajectory, group = Trajectory)) +
  geom_line() +
  geom_point() + ggtitle("Distance to WT pallial neurons")

```


# Cosine to KO pallial neurons

```{r}
Smoothed.point.cor <- cosMat(WT_CR.averages$RNA,
                             KO_Pal.averages$RNA)

WT_CR.dist <- diag(Smoothed.point.cor$cosine)

#
Smoothed.point.cor <- cosMat(KO_CR.averages$RNA,
                             KO_Pal.averages$RNA)


KO_CR.dist <- diag(Smoothed.point.cor$cosine)

#
Smoothed.point.cor <- cosMat(WT_Pal.averages$RNA,
                             KO_Pal.averages$RNA)

KO_Pal.dist <- diag(Smoothed.point.cor$cosine)
```

```{r}
data <- data.frame(Distance = c(WT_CR.dist, KO_CR.dist, KO_Pal.dist),
                   Trajectory = rep(c("WT_CR", "KO_CR", "WT_Pal"), each=nbreaks),
                   Pseudotime.bin = factor(rep(paste0("Bin_",1:nbreaks), 3),levels = paste0("Bin_",1:nbreaks)))

ggplot(data, aes(x= Pseudotime.bin, y= Distance, color= Trajectory, group = Trajectory)) +
  geom_line() +
  geom_point() + ggtitle("Distance to KO pallial neurons")

```

# Session Info

```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```

