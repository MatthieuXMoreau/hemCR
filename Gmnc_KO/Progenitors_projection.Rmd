---
title: "Progenitors projection and cell cycle inference"
author:
   - Matthieu Moreau^[Institute of Psychiatry and Neuroscience of Paris, INSERM U1266, 75014, Paris, France, matthieu.moreau@inserm.fr] [![](https://orcid.org/sites/default/files/images/orcid_16x16.png)](https://orcid.org/0000-0002-2592-2373)
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_download: yes
    df_print: tibble
    highlight: haddock
    theme: cosmo
    css: "../style.css"
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message=FALSE, warning=FALSE, cache.lazy = FALSE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(Matrix)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(ggExtra)
library(cowplot)
library(wesanderson)

#Set ggplot theme as classic
theme_set(theme_classic())
```

# Load both datasets

```{r}
WT.KO <- list(WT = readRDS("../QC.filtered.clustered.cells.RDS") %>%
                subset(subset = orig.ident == "Hem1" & Cell_ident %in% c("ChP_progenitors", "ChP",
                                                                         "Dorso-Medial_pallium", "Medial_pallium",
                                                                         "Hem", "Thalamic_eminence") ),
              KO = readRDS("./GmncKO.cells.RDS") %>% subset(idents = c(0,1,2,4)))

```


```{r}
p1 <- DimPlot(object = WT.KO[["WT"]],
        group.by = "Cell.state",
        reduction = "spring",
        cols = c("#31b6bd", "#ebcb2e", "#9ec22f", "#cc3a1b", "#d14c8d", "#4cabdc", "#5ab793", "#e7823a", "#046c9a", "#4990c9"),
        pt.size = 1.5
        )  & NoAxes()

p2 <- DimPlot(WT.KO[["KO"]],
        reduction = "spring",
        group.by = "Broadclust.ident",
        cols = c("#ebcb2e", "#9ec22f", "#a9961b", "#cc3a1b", "#d14c8d", "#4cabdc", "#5ab793", "grey90", "#e7823a", "#046c9a", "#4990c9"),
        pt.size = 1.5) & NoAxes()

p1 + p2
```

```{r}
WT.KO[["WT"]] <- NormalizeData(WT.KO[["WT"]], normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
WT.KO[["KO"]] <- NormalizeData(WT.KO[["KO"]], normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```

```{r}
WT.KO[["WT"]] <- FindVariableFeatures(WT.KO[["WT"]], selection.method = "vst", nfeatures = 2000)
WT.KO[["KO"]] <- FindVariableFeatures(WT.KO[["KO"]], selection.method = "vst", nfeatures = 2000)
```

```{r}
features <- SelectIntegrationFeatures(object.list = WT.KO, nfeatures = 1500)

TFs <- read.table("TF.csv", sep = ";")[,1]
TFs <- features[features %in% TFs]
```

# transfert identity labels WT to KO

```{r}
KO.anchors <- FindTransferAnchors(reference = WT.KO[["WT"]],
                                  query = WT.KO[["KO"]],
                                  features = features,
                                  reduction = "rpca",
                                  k.anchor = 5,
                                  k.filter = 100,
                                  k.score = 30,
                                  npcs = 25,
                                  dims = 1:25,
                                  max.features = 200)

predictions <- TransferData(anchorset = KO.anchors,
                            refdata = WT.KO[["WT"]]$Cell.state,
                            dims = 1:25)

WT.KO[["KO"]] <- AddMetaData(WT.KO[["KO"]], metadata = predictions)
```

```{r}
cols <- brewer.pal(n =11, name = "Spectral")

ggplot(WT.KO[["KO"]]@meta.data, aes(Spring_1, Spring_2)) +
  geom_point(aes(color=prediction.score.max), size=1, shape=16) + 
  scale_color_gradientn(colours=rev(cols), name='prediction.score.max')
```

```{r}
p1 <- DimPlot(object = WT.KO[["WT"]],
        group.by = "Cell.state",
        reduction = "spring",
        cols = c("#7293c8", "#b79f0b", "#3ca73f","#31b6bd",
                 "#ebcb2e", "#9ec22f", "#a9961b", "#cc3a1b",
                 "#d14c8d", "#4cabdc", "#5ab793", "#e7823a",
                 "#046c9a", "#4990c9"),
        pt.size = 1)  & NoAxes()

p2 <- DimPlot(WT.KO[["KO"]],
              group.by = "predicted.id",
              reduction = "spring",
              cols = c("#31b6bd", "#ebcb2e", "#9ec22f", "#a9961b", "#cc3a1b"),
              pt.size = 1) & NoAxes()

p1 + p2
```
# Transfert to the full dataset

```{r}
KO <- readRDS("./GmncKO.cells.RDS") %>% subset(idents = c(0,1,2,3,4))
```


```{r}
KO$Cell.ident <- sapply(KO$Barcodes,
                              FUN = function(x) {
                                if (x %in% WT.KO[["KO"]]$Barcodes) {
                                  x = WT.KO[["KO"]]@meta.data[x, "predicted.id"]
                                } else {
                                  x = KO@meta.data[x, "Broadclust.ident"]
                                  }
                              })
```


```{r}
DimPlot(object = KO,
        group.by = "Cell.ident",
        reduction = "spring",
        cols = c("#7293c8", "#b79f0b", "#3ca73f","#31b6bd",
                 "#ebcb2e", "#9ec22f", "#a9961b", "#cc3a1b",
                 "#d14c8d", "#4cabdc", "#5ab793", "#e7823a",
                 "#046c9a", "#4990c9"),
        pt.size = 1)  & NoAxes()
```

# Save the object

```{r Save RDS}
saveRDS(KO, "./GmncKO.progenitors_prohected.RDS")
```


# Session Info

```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```