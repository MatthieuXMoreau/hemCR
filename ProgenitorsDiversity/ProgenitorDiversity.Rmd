---
title: "Analysis of progenitors' diverity"
author:
   - Matthieu Moreau^[Institute of Psychiatry and Neuroscience of Paris, INSERM U1266, 75014, Paris, France, matthieu.moreau@inserm.fr] [![](https://orcid.org/sites/default/files/images/orcid_16x16.png)](https://orcid.org/0000-0002-2592-2373)
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_download: yes
    df_print: tibble
    highlight: haddock
    theme: cosmo
    css: "../style.css"
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message=FALSE, warning=FALSE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(fastTopics)
library(Matrix)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(ggExtra)
library(cowplot)
library(wesanderson)

#Set ggplot theme as classic
theme_set(theme_classic())
```

# load the dataset

```{r}
Hem.data <- readRDS("../QC.filtered.cells.RDS")
```

```{r}
DimPlot(Hem.data,
        reduction = "spring",
        cols = c(wes_palette("FantasticFox1"),"grey90"),
        pt.size = 0.5) & NoAxes()
```


# Extract the apical progenitors 

```{r}
# Extract apical progenitors 
Progenitors.data <-  subset(Hem.data, idents = c(0,1,3))

DimPlot(Progenitors.data,
        reduction = "spring",
        pt.size = 0.5,
        cols = c(wes_palette("FantasticFox1")[c(1,2,4)]),
        split.by = 'ident') + NoLegend() & NoAxes()

rm(Hem.data) ; gc()
```

# Filter gene counts matrix

For this analysis we will keep only genes detected in at least 20 over 12325 cells 

```{r}
progenitors.counts <- GetAssayData(object = Progenitors.data[["RNA"]], slot = "counts")
dim(progenitors.counts)

num.cells <- Matrix::rowSums(progenitors.counts > 0)
genes.use <- names(x = num.cells[which(x = num.cells >= 20)])
progenitors.counts <- progenitors.counts[genes.use, ]

dim(progenitors.counts)
```

# Topic modeling

## Fit topic model

```{r fit_topic_model ,cache=TRUE, class.output="scroll-100"} 
set.seed(1)

fit <- fit_topic_model(t(progenitors.counts),
                       k = 10,
                       numiter.main = 300,
                       numiter.refine = 300,
                       method.main = "em",
                       method.refine = "scd",
                       control.main = list(numiter = 4),
                       control.refine = list(numiter = 4, extrapolate = TRUE),
                       verbose = "progressbar")
```

```{r}
plot_progress(fit,x = "iter",add.point.every = 10,
                          colors = "black") +
  theme_cowplot(font_size = 10)
```

## Explore the different topics

```{r}
# Add cells' topics loading to the metadata
Progenitors.data@meta.data <- cbind(Progenitors.data@meta.data, fit$L)
```

```{r fig.dim=c(6, 9)}
plot <- FeaturePlot(object = Progenitors.data,
                    features.plot = paste0("k", 1:10),
                    cols.use = rev(brewer.pal(10,"Spectral")),
                    reduction.use = "spring",
                    no.legend = T,
                    overlay = F,
                    dark.theme = F,
                    do.return =T,
                    no.axes = T)

for (i in 1:length(plot)){
  plot[[i]]$data <- plot[[i]]$data[order(plot[[i]]$data$gene),]
}
```

```{r fig.dim=c(6, 5)}
cowplot::plot_grid(plotlist = plot[c(6,2,7,9)], ncol = 2)
```
## Cluster Progenitors

```{r}
set.seed(1)
pca <- prcomp(fit$L[,c(6,2,9,7)])$x
clusters <- cluster::pam(pca, k = 4)$clustering
```


```{r}
Progenitors.data@meta.data$TopicsKmeans <- as.numeric(clusters)

DimPlot(Progenitors.data,
        group.by = "TopicsKmeans",
        reduction.use = "spring",
        cols.use = c("#4cabdc","#046c9a", "#5ab793", "#e7823a","#4cabdc"),
        dim.1 = 1,
        dim.2 = 2,
        do.label=T,
        label.size = 4,
        no.legend = F)
```
```{r}

```


# Session Info

```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```