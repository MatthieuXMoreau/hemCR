---
title: "Cell cycle variable genes in neuronal progenitors"
author:
   - Matthieu Moreau^[Institute of Psychiatry and Neuroscience of Paris, INSERM U1266, 75014, Paris, France, matthieu.moreau@inserm.fr] [![](https://orcid.org/sites/default/files/images/orcid_16x16.png)](https://orcid.org/0000-0002-2592-2373)
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_download: yes
    df_print: tibble
    highlight: haddock
    theme: cosmo
    css: "../style.css"
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message=FALSE, warning=FALSE, cache.lazy = FALSE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(monocle)
library(Oscope)
library(Matrix)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(ggExtra)
library(cowplot)
library(wesanderson)

#Set ggplot theme as classic
theme_set(theme_classic())
```

# Load progenitors data

```{r}
Progenitors.data <- readRDS("Progenitors.RDS")
```

```{r fig.dim=c(6, 6)}
p1 <- FeaturePlot(object = Progenitors.data,
            features = "Revelio.cc",
            pt.size = 1,
            cols = rev(colorRampPalette(brewer.pal(n =10, name = "Spectral"))(100)),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- DimPlot(object = Progenitors.data,
        group.by = "Revelio.phase",
        pt.size = 1,
        reduction = "spring",
        cols =  c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) & NoAxes()

p1 + p2
```
# Find all cell cycle viariable genes common to all domains

## Initialize a monocle object

```{r}
rm(list = ls()[!ls() %in% c("Progenitors.data")])
gc()
```

```{r}
Progenitors.data <- NormalizeData(Progenitors.data, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")

Progenitors.data <- FindVariableFeatures(Progenitors.data, selection.method = "vst", nfeatures = 2000, assay = "RNA")
```


```{r}
# Transfer metadata
meta.data <- data.frame(barcode= Progenitors.data$Barcodes,
                        domain= Progenitors.data$Cell_ident,
                        Revelio.phase= Progenitors.data$Revelio.phase,
                        Revelio.cc= Progenitors.data$Revelio.cc)

Annot.data  <- new('AnnotatedDataFrame', data = meta.data)

# Transfer counts data
var.genes <- Progenitors.data[["RNA"]]@var.features
count.data = data.frame(gene_short_name = rownames(Progenitors.data[["RNA"]]@data[var.genes,]),
                        row.names = rownames(Progenitors.data[["RNA"]]@data[var.genes,]))

feature.data <- new('AnnotatedDataFrame', data = count.data)

# Create the CellDataSet object including variable genes only
gbm_cds <- newCellDataSet(Progenitors.data[["RNA"]]@counts[var.genes,],
                          phenoData = Annot.data,
                          featureData = feature.data,
                          lowerDetectionLimit = 0,
                          expressionFamily = negbinomial())
```

```{r message=FALSE, warning=FALSE}
gbm_cds <- estimateSizeFactors(gbm_cds)
gbm_cds <- estimateDispersions(gbm_cds)
gbm_cds <- detectGenes(gbm_cds, min_expr = 0.1)
```
## Test each gene trend over pseudotime score

### Find genes DE along pseudomaturation axis

```{r cache= TRUE, message=FALSE, warning=FALSE}
Cellcycle.diff <- differentialGeneTest(gbm_cds[fData(gbm_cds)$num_cells_expressed > 200,], 
                                                 fullModelFormulaStr = "~sm.ns(Revelio.cc, df = 3)*domain", 
                                                 reducedModelFormulaStr = "~domain", 
                                                 cores = parallel::detectCores() - 2)

```

```{r}
# Filter genes based on FDR
Cellcycle.diff.filtered <- Cellcycle.diff %>% filter(qval < 5e-10)
```

## Smooth expression of significative genes

```{r cache= TRUE}
# Create a new vector of 200 points
nPoints <- 200
new_data <- data.frame(Revelio.cc = seq(min(pData(gbm_cds)$Revelio.cc), max(pData(gbm_cds)$Revelio.cc), length.out = nPoints))

# Smooth gene expression
Smooth.curve.matrix <- genSmoothCurves(gbm_cds[as.character(Cellcycle.diff.filtered$gene_short_name),],
                                       trend_formula = "~sm.ns(Revelio.cc, df = 3)",
                                       relative_expr = TRUE,
                                       new_data = new_data,
                                       cores= parallel::detectCores() - 2)
```

## Cluster genes and plot heatmap

```{r}
## Cluster gene by expression profiles
Pseudotime.genes.clusters <- cluster::pam(as.dist((1 - cor(Matrix::t(Smooth.curve.matrix),method = "spearman"))), k= 5)

Ccycle.Gene.dynamique <- data.frame(Gene= names(Pseudotime.genes.clusters$clustering),
                                 Waves= Pseudotime.genes.clusters$clustering,
                                 Gene.Clusters = Pseudotime.genes.clusters$clustering,
                                 q.val = Cellcycle.diff.filtered$qval
                                 ) %>% arrange(Gene.Clusters)

row.names(Ccycle.Gene.dynamique) <- Ccycle.Gene.dynamique$Gene
Ccycle.Gene.dynamique$Gene.Clusters <- paste0("Clust.", Ccycle.Gene.dynamique$Gene.Clusters)
```

```{r}
# Order the rows using seriation
dst <- as.dist((1-cor(scale(t(Smooth.curve.matrix)), method = "spearman")))
row.ser <- seriation::seriate(dst, method ="R2E") #"R2E" #TSP #"GW" "GW_ward"
gene.order <- rownames(Smooth.curve.matrix[seriation::get_order(row.ser),])

pal <- wes_palette("Darjeeling1")
anno.colors <- list(Cell.state = c(Cycling_RG="#046c9a", Differentiating_cells="#ebcb2e"),
                    Gene.Clusters = c(Clust.1 =pal[1] , Clust.2=pal[2], Clust.3=pal[3], Clust.4=pal[4], Clust.5=pal[5]))

col.anno <- data.frame(Cell.state = rep(c("Cycling_RG","Differentiating_cells"), each=100))

pheatmap::pheatmap(Smooth.curve.matrix[gene.order,],
                   scale = "row",
                   cluster_rows = F,
                   cluster_cols = F,
                   annotation_row = Ccycle.Gene.dynamique %>% dplyr::select(Gene.Clusters),
                   #annotation_col = col.anno,
                   annotation_colors = anno.colors,
                   show_colnames = F,
                   show_rownames = F,
                   fontsize_row = 8,
                   color =  viridis::viridis(9),
                   breaks = seq(-2.5,2.5, length.out = 9),
                   main = "")
```



# Session Info

```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```