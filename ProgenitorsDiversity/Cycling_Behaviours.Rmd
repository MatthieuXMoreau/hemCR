---
title: "Comparison between progenitor domain cycling behaviour"
author:
   - Matthieu Moreau^[Institute of Psychiatry and Neuroscience of Paris, INSERM U1266, 75014, Paris, France, matthieu.moreau@inserm.fr] [![](https://orcid.org/sites/default/files/images/orcid_16x16.png)](https://orcid.org/0000-0002-2592-2373)
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    code_download: yes
    df_print: tibble
    highlight: haddock
    theme: cosmo
    css: "../style.css"
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', message=FALSE, warning=FALSE, cache.lazy = FALSE)

# To use biomart 
new_config <- httr::config(ssl_verifypeer = FALSE)
httr::set_config(new_config, override = FALSE)
```

# Load libraries

```{r message=FALSE, warning=FALSE}
library(Seurat)
library(monocle)
library(Matrix)
library(dplyr)
library(RColorBrewer)
library(ggplot2)
library(ggExtra)
library(cowplot)
library(wesanderson)

#Set ggplot theme as classic
theme_set(theme_classic())
```

# Load progenitors data

```{r}
Progenitors.data <- readRDS("Progenitors.RDS")
```

```{r fig.dim=c(6, 6)}
p1 <- FeaturePlot(object = Progenitors.data,
            features = "Revelio.cc",
            pt.size = 1,
            cols = rev(colorRampPalette(brewer.pal(n =10, name = "Spectral"))(100)),
            reduction = "spring",
            order = T) & NoAxes()

p2 <- DimPlot(object = Progenitors.data,
        group.by = "Revelio.phase",
        pt.size = 1,
        reduction = "spring",
        cols =  c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) & NoAxes()

p1 + p2
```
# Normalization

```{r}
Progenitors.data <- NormalizeData(Progenitors.data, normalization.method = "LogNormalize", scale.factor = 10000, assay = "RNA")
```
```{r}
Progenitors.data <- FindVariableFeatures(Progenitors.data, selection.method = "vst", nfeatures = 2000, assay = "RNA")
```


# Plot some genes trend along cycling axis

```{r}
Cell.cycle.trend <- function(Seurat.data,
                             group.by,
                             gene){
  
  data <- Seurat.data@meta.data %>% select("Revelio.cc", "Revelio.phase", "Cell_ident")
  data$Gene <- Progenitors.data@assays$RNA@data[gene,]
  
  if (!group.by == "Cell_ident") {
    p <- ggplot(data=data, aes(x= Revelio.cc, y= Gene)) +
        geom_point(aes(color= Revelio.phase), size=0.5) +
        scale_color_manual(values= c(wes_palette("FantasticFox1")[1:3],"grey40",wes_palette("FantasticFox1")[5])) +
        geom_smooth(method="loess", n= 50, fill="grey") +
        ylim(0,NA) +
        ggtitle(gene)
  } else {
    p <- ggplot(data=data, aes(x= Revelio.cc, y= Gene)) +
        geom_point(aes(color= Cell_ident), size=0.5) +
        scale_color_manual(values= c("#68b041", "#e3c148", "#e46b6b")) +
        geom_smooth(method="loess", n= 50, aes(color= Cell_ident)) +
        ylim(0,NA) +
        ggtitle(gene)
  }
  
  
  return(p)
}


Plot.Genes.trend <- function(Seurat.data,
                             group.by,
                             genes){
  pList <- mapply(FUN = Cell.cycle.trend, gene = genes,
                  MoreArgs = list(Seurat.data = Seurat.data, group.by=group.by),
                  SIMPLIFY = FALSE)
  print(x = cowplot::plot_grid(plotlist = pList, ncol = 2))
} 
```

```{r fig.dim=c(9,12)}
Plot.Genes.trend(Seurat.data= Progenitors.data,
                 group.by = "Revelio.phase",
                 genes= c("Ccna2", "Ccne1",
                          "Ccnb2", "Ccnb1",
                          "Cdk1", "Pcna",
                          "Mcm6", "Hist1h2bc",
                          "Top2a", "Tpx2",
                          "Hes1", "Hes6",
                          "Hes5","Neurog2"))

```

```{r fig.dim=c(9,10)}
Plot.Genes.trend(Seurat.data= Progenitors.data,
                 group.by = "Revelio.phase",
                 genes= c("Neurog2", "Btg2",
                          "Hes6", "Dll1",
                          "Gadd45g","Magi1",
                          "Elavl4", "Mfng",
                          "Foxn3","Spsb1"))
```
```{r fig.dim=c(9,9)}
Plot.Genes.trend(Seurat.data= Progenitors.data,
                 group.by = "Cell_ident",
                 genes= c("Foxn3","Spsb1",
                          "Cdkn1c","H2afx",
                          "Nkd1", "Wls",
                          "Gmnc", "Ooep",
                          "Bok", "Cdk6",
                          "Skil", "Rassf4",
                          "Cenpw","Folr1"))
```

# Use monocle2 to model gene expression along cycling axis

## Initialize a monocle object

```{r}
# Transfer metadata
domain <- as.character(ifelse(Progenitors.data$Cell_ident == "Hem",
                              "Hem", "Pallium"))

meta.data <- data.frame(barcode= Progenitors.data$Barcodes,
                        domain= domain,
                        Revelio.phase= Progenitors.data$Revelio.phase,
                        Revelio.cc= Progenitors.data$Revelio.cc)

Annot.data  <- new('AnnotatedDataFrame', data = meta.data)

# Transfer counts data
var.genes <- Progenitors.data[["RNA"]]@var.features
count.data = data.frame(gene_short_name = rownames(Progenitors.data[["RNA"]]@data[var.genes,]),
                        row.names = rownames(Progenitors.data[["RNA"]]@data[var.genes,]))

feature.data <- new('AnnotatedDataFrame', data = count.data)

# Create the CellDataSet object including variable genes only
gbm_cds <- newCellDataSet(Progenitors.data[["RNA"]]@counts[var.genes,],
                          phenoData = Annot.data,
                          featureData = feature.data,
                          lowerDetectionLimit = 0,
                          expressionFamily = negbinomial())
```

```{r message=FALSE, warning=FALSE}
gbm_cds <- estimateSizeFactors(gbm_cds)
gbm_cds <- estimateDispersions(gbm_cds)
gbm_cds <- detectGenes(gbm_cds, min_expr = 0.1)
```

```{r}
rm(list = ls()[!ls() %in% c("Progenitors.data", "gbm_cds", "Gene.Trend", "Plot.Genes.trend")])
gc()
```

## Test each gene trend over pseudotime score

### Find genes DE along pseudomaturation axis

```{r message=FALSE, warning=FALSE}
pseudo.maturation.diff <- differentialGeneTest(gbm_cds, 
                                                 fullModelFormulaStr = "~sm.ns(Revelio.cc, df = 3)*domain", 
                                                 reducedModelFormulaStr = "~sm.ns(Revelio.cc, df = 3)", 
                                                 cores = parallel::detectCores() - 2)

```

```{r}
# Filter genes based on FDR
pseudo.maturation.diff.filtered <- pseudo.maturation.diff %>% filter(qval < 5e-3)
```

# Session Info

```{r}
#date
format(Sys.time(), "%d %B, %Y, %H,%M")

#Packages used
sessionInfo()
```